jobs:
  - deployment: Deploy
    displayName: Deploy Container Apps

    # Fake environment (history/tracebility only)
    environment: '${{ variables.environmentName }}'

    strategy:
      runOnce:
        deploy:
          steps:
          # Checkout to Build.SourcesDirectory
          - checkout: self

          # Install terraform
          - task: TerraformInstaller@1
            displayName: Install Terraform

          # Install terragrunt
          - task: Bash@3
            displayName: Install Terragrunt and tflint
            inputs:
              targetType: inline
              script: |
                curl -sLo /usr/local/bin/terragrunt   https://github.com/gruntwork-io/terragrunt/releases/download/v0.55.1/terragrunt_linux_amd64
                chmod +x /usr/local/bin/terragrunt
                curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash

          # Generate teragrunt deployment variables
          - task: PowerShell@2
            displayName:  Generate deployment variables file
            inputs:
              targetType: inline
              pwsh: true
              workingDirectory: '$(Build.SourcesDirectory)/terraform/demoapp.v2/envs/prod'
              script: |
                $json_str  = @{
                  app_tag = '${{ variables.tag }}'
                } | ConvertTo-Json
                $json_str | Write-Output
                $json_str | Out-File -FilePath 'deploy-vars.json' -Encoding utf8 -Force

          # Run terragrunt deployment for prod environment
          - task: AzureCLI@2
            displayName: Deploy Prod environment
            inputs:
              azureSubscription: ${{ variables.armServiceConnection }}
              scriptType: bash
              scriptLocation: inlineScript
              workingDirectory: '$(Build.SourcesDirectory)/terraform/demoapp.v2/envs/prod'
              addSpnToEnvironment: true
              inlineScript: |
                export ARM_CLIENT_ID="$servicePrincipalId"
                export ARM_CLIENT_SECRET="$servicePrincipalKey"
                export ARM_TENANT_ID="$tenantId"
                export ARM_SUBSCRIPTION_ID="${{ variables.armSubscriptionId }}"
                terragrunt run-all apply -auto-approve --terragrunt-non-interactive

          # Terraform output - get URLs of the apps
          - task: AzureCLI@2
            name: tfoutput
            displayName: Get URLs of the deployed apps
            inputs:
              azureSubscription: ${{ variables.armServiceConnection }}
              scriptType: pscore
              scriptLocation: inlineScript
              workingDirectory: '$(Build.SourcesDirectory)/terraform/demoapp.v2/envs/prod/apps'
              addSpnToEnvironment: true
              inlineScript: |
                $Env:ARM_CLIENT_ID = "$Env:servicePrincipalId"
                $Env:ARM_CLIENT_SECRET = "$Env:servicePrincipalKey"
                $Env:ARM_TENANT_ID = "$Env:tenantId"
                $Env:ARM_SUBSCRIPTION_ID = "${{ variables.armSubscriptionId }}"

                $tf_output = terragrunt output -json | ConvertFrom-Json
                $urls = $tf_output.apps_url.value | %{ return "https://" + $_  } | Join-String -Separator ","
                Write-Host "Application URL list: ${urls}"
                Write-Host "##vso[task.setvariable variable=tf_app_urls;isOutput=true]${urls}"

# Verification job
  - job: Verify
    displayName: Run verification tests
    dependsOn: Deploy

    variables:
      terraformAppUrls: $[dependencies.Deploy.outputs['Deploy.tfoutput.tf_app_urls']]
    steps:
    - script: |
        pip install --upgrade pip
        pip install --upgrade pytest pytest-azurepipelines urllib3
      displayName: 'Install dependencies'

    - script: |
        echo "URLs: $(terraformAppUrls)"
        echo "Whait 10 seconds before test"
        sleep 10
        pytest --app-urls "$(terraformAppUrls)" --commit "$(Build.SourceVersion)"
      displayName: 'Run infra tests'
      workingDirectory: $(Build.SourcesDirectory)/infra-tests